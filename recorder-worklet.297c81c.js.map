{"version":3,"sources":["webpack:///webpack/bootstrap","webpack:///./matrix-react-sdk/node_modules/@babel/runtime/helpers/defineProperty.js","webpack:///./matrix-react-sdk/src/audio/consts.ts","webpack:///./matrix-react-sdk/src/utils/numbers.ts","webpack:///./matrix-react-sdk/src/audio/RecorderWorklet.ts"],"names":["WORKLET_NAME","PayloadEvent","defaultNumber","i","def","Number","isFinite","clamp","min","max","Math","sum","reduce","p","c","percentageWithin","pct","percentageOf","val","TARGET_AMPLITUDE_FREQUENCY","roundTimeToTargetFreq","seconds","round","EPSILON","nextTimeForTargetFreq","roundedSeconds","MxVoiceWorklet","AudioWorkletProcessor","process","inputs","outputs","parameters","currentSecond","currentTime","nextAmplitudeSecond","monoChan","minVal","maxVal","amplitude","port","postMessage","ev","AmplitudeMark","forIndex","amplitudeIndex","Timekeep","timeSeconds","registerProcessor"],"mappings":"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","file":"recorder-worklet.297c81c.js","sourcesContent":[" \t// The module cache\n \tvar installedModules = {};\n\n \t// The require function\n \tfunction __webpack_require__(moduleId) {\n\n \t\t// Check if module is in cache\n \t\tif(installedModules[moduleId]) {\n \t\t\treturn installedModules[moduleId].exports;\n \t\t}\n \t\t// Create a new module (and put it into the cache)\n \t\tvar module = installedModules[moduleId] = {\n \t\t\ti: moduleId,\n \t\t\tl: false,\n \t\t\texports: {}\n \t\t};\n\n \t\t// Execute the module function\n \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n \t\t// Flag the module as loaded\n \t\tmodule.l = true;\n\n \t\t// Return the exports of the module\n \t\treturn module.exports;\n \t}\n\n\n \t// expose the modules object (__webpack_modules__)\n \t__webpack_require__.m = modules;\n\n \t// expose the module cache\n \t__webpack_require__.c = installedModules;\n\n \t// define getter function for harmony exports\n \t__webpack_require__.d = function(exports, name, getter) {\n \t\tif(!__webpack_require__.o(exports, name)) {\n \t\t\tObject.defineProperty(exports, name, { enumerable: true, get: getter });\n \t\t}\n \t};\n\n \t// define __esModule on exports\n \t__webpack_require__.r = function(exports) {\n \t\tif(typeof Symbol !== 'undefined' && Symbol.toStringTag) {\n \t\t\tObject.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });\n \t\t}\n \t\tObject.defineProperty(exports, '__esModule', { value: true });\n \t};\n\n \t// create a fake namespace object\n \t// mode & 1: value is a module id, require it\n \t// mode & 2: merge all properties of value into the ns\n \t// mode & 4: return value when already ns object\n \t// mode & 8|1: behave like require\n \t__webpack_require__.t = function(value, mode) {\n \t\tif(mode & 1) value = __webpack_require__(value);\n \t\tif(mode & 8) return value;\n \t\tif((mode & 4) && typeof value === 'object' && value && value.__esModule) return value;\n \t\tvar ns = Object.create(null);\n \t\t__webpack_require__.r(ns);\n \t\tObject.defineProperty(ns, 'default', { enumerable: true, value: value });\n \t\tif(mode & 2 && typeof value != 'string') for(var key in value) __webpack_require__.d(ns, key, function(key) { return value[key]; }.bind(null, key));\n \t\treturn ns;\n \t};\n\n \t// getDefaultExport function for compatibility with non-harmony modules\n \t__webpack_require__.n = function(module) {\n \t\tvar getter = module && module.__esModule ?\n \t\t\tfunction getDefault() { return module['default']; } :\n \t\t\tfunction getModuleExports() { return module; };\n \t\t__webpack_require__.d(getter, 'a', getter);\n \t\treturn getter;\n \t};\n\n \t// Object.prototype.hasOwnProperty.call\n \t__webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };\n\n \t// __webpack_public_path__\n \t__webpack_require__.p = \"\";\n\n\n \t// Load entry module and return exports\n \treturn __webpack_require__(__webpack_require__.s = 1);\n","function _defineProperty(obj, key, value) {\n  if (key in obj) {\n    Object.defineProperty(obj, key, {\n      value: value,\n      enumerable: true,\n      configurable: true,\n      writable: true\n    });\n  } else {\n    obj[key] = value;\n  }\n\n  return obj;\n}\n\nmodule.exports = _defineProperty, module.exports.__esModule = true, module.exports[\"default\"] = module.exports;","/*\nCopyright 2021 The Matrix.org Foundation C.I.C.\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n*/\n\nexport const WORKLET_NAME = \"mx-voice-worklet\";\n\nexport enum PayloadEvent {\n    Timekeep = \"timekeep\",\n    AmplitudeMark = \"amplitude_mark\",\n}\n\nexport interface IPayload {\n    ev: PayloadEvent;\n}\n\nexport interface ITimingPayload extends IPayload {\n    ev: PayloadEvent.Timekeep;\n    timeSeconds: number;\n}\n\nexport interface IAmplitudePayload extends IPayload {\n    ev: PayloadEvent.AmplitudeMark;\n    forIndex: number;\n    amplitude: number;\n}\n","/*\nCopyright 2021 The Matrix.org Foundation C.I.C.\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n*/\n\n/**\n * Returns the default number if the given value, i, is not a number. Otherwise\n * returns the given value.\n * @param {*} i The value to check.\n * @param {number} def The default value.\n * @returns {number} Either the value or the default value, whichever is a number.\n */\nexport function defaultNumber(i: unknown, def: number): number {\n    return Number.isFinite(i) ? Number(i) : def;\n}\n\nexport function clamp(i: number, min: number, max: number): number {\n    return Math.min(Math.max(i, min), max);\n}\n\nexport function sum(...i: number[]): number {\n    return [...i].reduce((p, c) => c + p, 0);\n}\n\nexport function percentageWithin(pct: number, min: number, max: number): number {\n    return (pct * (max - min)) + min;\n}\n\nexport function percentageOf(val: number, min: number, max: number): number {\n    return (val - min) / (max - min);\n}\n","/*\nCopyright 2021 The Matrix.org Foundation C.I.C.\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n*/\n\nimport { IAmplitudePayload, ITimingPayload, PayloadEvent, WORKLET_NAME } from \"./consts\";\nimport { percentageOf } from \"../utils/numbers\";\n\n// from AudioWorkletGlobalScope: https://developer.mozilla.org/en-US/docs/Web/API/AudioWorkletGlobalScope\ndeclare const currentTime: number;\n// declare const currentFrame: number;\n// declare const sampleRate: number;\n\n// We rate limit here to avoid overloading downstream consumers with amplitude information.\n// The two major consumers are the voice message waveform thumbnail (resampled down to an\n// appropriate length) and the live waveform shown to the user. Effectively, this controls\n// the refresh rate of that live waveform and the number of samples the thumbnail has to\n// work with.\nconst TARGET_AMPLITUDE_FREQUENCY = 16; // Hz\n\nfunction roundTimeToTargetFreq(seconds: number): number {\n    // Epsilon helps avoid floating point rounding issues (1 + 1 = 1.999999, etc)\n    return Math.round((seconds + Number.EPSILON) * TARGET_AMPLITUDE_FREQUENCY) / TARGET_AMPLITUDE_FREQUENCY;\n}\n\nfunction nextTimeForTargetFreq(roundedSeconds: number): number {\n    // The extra round is just to make sure we cut off any floating point issues\n    return roundTimeToTargetFreq(roundedSeconds + (1 / TARGET_AMPLITUDE_FREQUENCY));\n}\n\nclass MxVoiceWorklet extends AudioWorkletProcessor {\n    private nextAmplitudeSecond = 0;\n    private amplitudeIndex = 0;\n\n    process(inputs, outputs, parameters) {\n        const currentSecond = roundTimeToTargetFreq(currentTime);\n        // We special case the first ping because there's a fairly good chance that we'll miss the zeroth\n        // update. Firefox for instance takes 0.06 seconds (roughly) to call this function for the first\n        // time. Edge and Chrome occasionally lag behind too, but for the most part are on time.\n        //\n        // When this doesn't work properly we end up producing a waveform of nulls and no live preview\n        // of the recorded message.\n        if (currentSecond === this.nextAmplitudeSecond || this.nextAmplitudeSecond === 0) {\n            // We're expecting exactly one mono input source, so just grab the very first frame of\n            // samples for the analysis.\n            const monoChan = inputs[0][0];\n\n            // The amplitude of the frame's samples is effectively the loudness of the frame. This\n            // translates into a bar which can be rendered as part of the whole recording clip's\n            // waveform.\n            //\n            // We translate the amplitude down to 0-1 for sanity's sake.\n            const minVal = Math.min(...monoChan);\n            const maxVal = Math.max(...monoChan);\n            const amplitude = percentageOf(maxVal, -1, 1) - percentageOf(minVal, -1, 1);\n\n            this.port.postMessage(<IAmplitudePayload>{\n                ev: PayloadEvent.AmplitudeMark,\n                amplitude: amplitude,\n                forIndex: this.amplitudeIndex++,\n            });\n            this.nextAmplitudeSecond = nextTimeForTargetFreq(currentSecond);\n        }\n\n        // We mostly use this worklet to fire regular clock updates through to components\n        this.port.postMessage(<ITimingPayload>{ ev: PayloadEvent.Timekeep, timeSeconds: currentTime });\n\n        // We're supposed to return false when we're \"done\" with the audio clip, but seeing as\n        // we are acting as a passive processor we are never truly \"done\". The browser will clean\n        // us up when it is done with us.\n        return true;\n    }\n}\n\nregisterProcessor(WORKLET_NAME, MxVoiceWorklet);\n\nexport default null; // to appease module loaders (we never use the export)\n"],"sourceRoot":""}