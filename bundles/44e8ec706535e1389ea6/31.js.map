{"version":3,"sources":["webpack:///./matrix-react-sdk/src/async-components/views/dialogs/eventindex/ManageEventIndexDialog.tsx"],"names":["ManageEventIndexDialog","React","Component","constructor","props","room","eventIndex","EventIndexPeg","get","stats","getStats","currentRoom","name","roomStats","crawlingRooms","crawlingRoomsCount","size","roomCount","totalRooms","setState","eventIndexSize","eventCount","DisableEventIndexDialog","default","Modal","createTrackedDialog","e","crawlerSleepTime","target","value","SettingsStore","setValue","SettingLevel","DEVICE","state","getValueAt","componentWillUnmount","removeListener","updateCurrentRoom","componentDidMount","on","render","brand","SdkConfig","crawlerState","_t","doneRooms","Math","max","eventIndexingSettings","formatBytes","formatCountLong","toString","onCrawlerSleepTimeChange","onFinished","onDisable"],"mappings":"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","file":"bundles/44e8ec706535e1389ea6/31.js","sourcesContent":["/*\nCopyright 2020-2021 The Matrix.org Foundation C.I.C.\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n*/\n\nimport React from 'react';\n\nimport { _t } from '../../../../languageHandler';\nimport SdkConfig from '../../../../SdkConfig';\nimport SettingsStore from \"../../../../settings/SettingsStore\";\nimport Modal from '../../../../Modal';\nimport { formatBytes, formatCountLong } from \"../../../../utils/FormattingUtils\";\nimport EventIndexPeg from \"../../../../indexing/EventIndexPeg\";\nimport { SettingLevel } from \"../../../../settings/SettingLevel\";\nimport Field from '../../../../components/views/elements/Field';\nimport BaseDialog from \"../../../../components/views/dialogs/BaseDialog\";\nimport DialogButtons from \"../../../../components/views/elements/DialogButtons\";\nimport { IDialogProps } from \"../../../../components/views/dialogs/IDialogProps\";\n\ninterface IProps extends IDialogProps {}\n\ninterface IState {\n    eventIndexSize: number;\n    eventCount: number;\n    crawlingRoomsCount: number;\n    roomCount: number;\n    currentRoom: string;\n    crawlerSleepTime: number;\n}\n\n/*\n * Allows the user to introspect the event index state and disable it.\n */\nexport default class ManageEventIndexDialog extends React.Component<IProps, IState> {\n    constructor(props) {\n        super(props);\n\n        this.state = {\n            eventIndexSize: 0,\n            eventCount: 0,\n            crawlingRoomsCount: 0,\n            roomCount: 0,\n            currentRoom: null,\n            crawlerSleepTime:\n                SettingsStore.getValueAt(SettingLevel.DEVICE, 'crawlerSleepTime'),\n        };\n    }\n\n    updateCurrentRoom = async (room) => {\n        const eventIndex = EventIndexPeg.get();\n        let stats;\n\n        try {\n            stats = await eventIndex.getStats();\n        } catch {\n            // This call may fail if sporadically, not a huge issue as we will\n            // try later again and probably succeed.\n            return;\n        }\n\n        let currentRoom = null;\n\n        if (room) currentRoom = room.name;\n        const roomStats = eventIndex.crawlingRooms();\n        const crawlingRoomsCount = roomStats.crawlingRooms.size;\n        const roomCount = roomStats.totalRooms.size;\n\n        this.setState({\n            eventIndexSize: stats.size,\n            eventCount: stats.eventCount,\n            crawlingRoomsCount: crawlingRoomsCount,\n            roomCount: roomCount,\n            currentRoom: currentRoom,\n        });\n    };\n\n    componentWillUnmount(): void {\n        const eventIndex = EventIndexPeg.get();\n\n        if (eventIndex !== null) {\n            eventIndex.removeListener(\"changedCheckpoint\", this.updateCurrentRoom);\n        }\n    }\n\n    async componentDidMount(): Promise<void> {\n        let eventIndexSize = 0;\n        let crawlingRoomsCount = 0;\n        let roomCount = 0;\n        let eventCount = 0;\n        let currentRoom = null;\n\n        const eventIndex = EventIndexPeg.get();\n\n        if (eventIndex !== null) {\n            eventIndex.on(\"changedCheckpoint\", this.updateCurrentRoom);\n\n            try {\n                const stats = await eventIndex.getStats();\n                eventIndexSize = stats.size;\n                eventCount = stats.eventCount;\n            } catch {\n                // This call may fail if sporadically, not a huge issue as we\n                // will try later again in the updateCurrentRoom call and\n                // probably succeed.\n            }\n\n            const roomStats = eventIndex.crawlingRooms();\n            crawlingRoomsCount = roomStats.crawlingRooms.size;\n            roomCount = roomStats.totalRooms.size;\n\n            const room = eventIndex.currentRoom();\n            if (room) currentRoom = room.name;\n        }\n\n        this.setState({\n            eventIndexSize,\n            eventCount,\n            crawlingRoomsCount,\n            roomCount,\n            currentRoom,\n        });\n    }\n\n    private onDisable = async () => {\n        const DisableEventIndexDialog = (await import(\"./DisableEventIndexDialog\")).default;\n        Modal.createTrackedDialog(\"Disable message search\", \"Disable message search\",\n            DisableEventIndexDialog,\n            null, null, /* priority = */ false, /* static = */ true,\n        );\n    };\n\n    private onCrawlerSleepTimeChange = (e) => {\n        this.setState({ crawlerSleepTime: e.target.value });\n        SettingsStore.setValue(\"crawlerSleepTime\", null, SettingLevel.DEVICE, e.target.value);\n    };\n\n    render() {\n        const brand = SdkConfig.get().brand;\n\n        let crawlerState;\n        if (this.state.currentRoom === null) {\n            crawlerState = _t(\"Not currently indexing messages for any room.\");\n        } else {\n            crawlerState = (\n                _t(\"Currently indexing: %(currentRoom)s\", { currentRoom: this.state.currentRoom })\n            );\n        }\n\n        const doneRooms = Math.max(0, (this.state.roomCount - this.state.crawlingRoomsCount));\n\n        const eventIndexingSettings = (\n            <div>\n                { _t(\n                    \"%(brand)s is securely caching encrypted messages locally for them \" +\n                    \"to appear in search results:\",\n                    { brand },\n                ) }\n                <div className='mx_SettingsTab_subsectionText'>\n                    { crawlerState }<br />\n                    { _t(\"Space used:\") } { formatBytes(this.state.eventIndexSize, 0) }<br />\n                    { _t(\"Indexed messages:\") } { formatCountLong(this.state.eventCount) }<br />\n                    { _t(\"Indexed rooms:\") } { _t(\"%(doneRooms)s out of %(totalRooms)s\", {\n                        doneRooms: formatCountLong(doneRooms),\n                        totalRooms: formatCountLong(this.state.roomCount),\n                    }) } <br />\n                    <Field\n                        label={_t('Message downloading sleep time(ms)')}\n                        type='number'\n                        value={this.state.crawlerSleepTime.toString()}\n                        onChange={this.onCrawlerSleepTimeChange} />\n                </div>\n            </div>\n        );\n\n        return (\n            <BaseDialog className='mx_ManageEventIndexDialog'\n                onFinished={this.props.onFinished}\n                title={_t(\"Message search\")}\n            >\n                { eventIndexingSettings }\n                <DialogButtons\n                    primaryButton={_t(\"Done\")}\n                    onPrimaryButtonClick={this.props.onFinished}\n                    primaryButtonClass=\"primary\"\n                    cancelButton={_t(\"Disable\")}\n                    onCancel={this.onDisable}\n                    cancelButtonClass=\"danger\"\n                />\n            </BaseDialog>\n        );\n    }\n}\n"],"sourceRoot":""}