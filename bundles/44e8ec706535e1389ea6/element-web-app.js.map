{"version":3,"sources":["webpack:///./src/vector/app.tsx"],"names":["window","React","logger","log","process","matrixLogger","makeRegistrationUrl","params","url","location","protocol","host","pathname","keys","Object","i","length","k","encodeURIComponent","onTokenLoginCompleted","URL","href","searchParams","delete","history","replaceState","loadApp","fragParams","initRouting","platform","PlatformPeg","get","parseQs","urlWithoutQuery","startUpdater","config","verifyServerConfig","snakedConfig","SnakedObject","userId","Lifecycle","hasPossibleToken","isReturningFromSso","loginToken","ssoRedirects","parseSsoRedirectOptions","autoRedirect","immediate","isWelcomeOrLanding","hash","on_welcome_page","tempCli","createClient","baseUrl","validated_server_config","hsUrl","idBaseUrl","isUrl","startSingleSignOn","getScreenFromLocation","screen","defaultDeviceName","getDefaultDeviceDisplayName","MatrixChat","sdk","onNewScreen","disable_guests","validatedConfig","SdkConfig","wkConfig","serverName","incompatibleOptions","filter","newTranslatableError","_td","warn","discoveryResult","AutoDiscovery","fromDiscoveryConfig","findClientConfig","AutoDiscoveryUtils","buildValidatedConfigFromDiscovery","e","error","validateServerConfigWithStaticUrls","isDefault","add"],"mappings":"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","file":"bundles/44e8ec706535e1389ea6/element-web-app.js","sourcesContent":["/*\nCopyright 2015, 2016 OpenMarket Ltd\nCopyright 2017 Vector Creations Ltd\nCopyright 2018, 2019 New Vector Ltd\nCopyright 2019 Michael Telatynski <7t3chguy@gmail.com>\nCopyright 2020 The Matrix.org Foundation C.I.C.\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n*/\n\nimport React from 'react';\nimport * as sdk from 'matrix-react-sdk/src/index';\nimport PlatformPeg from 'matrix-react-sdk/src/PlatformPeg';\nimport { _td, newTranslatableError } from 'matrix-react-sdk/src/languageHandler';\nimport AutoDiscoveryUtils from 'matrix-react-sdk/src/utils/AutoDiscoveryUtils';\nimport { AutoDiscovery } from \"matrix-js-sdk/src/autodiscovery\";\nimport * as Lifecycle from \"matrix-react-sdk/src/Lifecycle\";\nimport SdkConfig, { parseSsoRedirectOptions } from \"matrix-react-sdk/src/SdkConfig\";\nimport { IConfigOptions } from \"matrix-react-sdk/src/IConfigOptions\";\nimport { logger } from \"matrix-js-sdk/src/logger\";\nimport { createClient } from \"matrix-js-sdk/src/matrix\";\nimport { SnakedObject } from \"matrix-react-sdk/src/utils/SnakedObject\";\n\nimport { parseQs } from './url_utils';\nimport VectorBasePlatform from \"./platform/VectorBasePlatform\";\nimport { getScreenFromLocation, init as initRouting, onNewScreen } from \"./routing\";\n\n// add React and ReactPerf to the global namespace, to make them easier to access via the console\n// this incidentally means we can forget our React imports in JSX files without penalty.\nwindow.React = React;\n\nlogger.log(`Application is running in ${process.env.NODE_ENV} mode`);\n\nwindow.matrixLogger = logger;\n\n// We use this to work out what URL the SDK should\n// pass through when registering to allow the user to\n// click back to the client having registered.\n// It's up to us to recognise if we're loaded with\n// this URL and tell MatrixClient to resume registration.\n//\n// If we're in electron, we should never pass through a file:// URL otherwise\n// the identity server will try to 302 the browser to it, which breaks horribly.\n// so in that instance, hardcode to use app.element.io for now instead.\nfunction makeRegistrationUrl(params: object) {\n    let url;\n    if (window.location.protocol === \"vector:\") {\n        url = 'https://app.element.io/#/register';\n    } else {\n        url = (\n            window.location.protocol + '//' +\n            window.location.host +\n            window.location.pathname +\n            '#/register'\n        );\n    }\n\n    const keys = Object.keys(params);\n    for (let i = 0; i < keys.length; ++i) {\n        if (i === 0) {\n            url += '?';\n        } else {\n            url += '&';\n        }\n        const k = keys[i];\n        url += k + '=' + encodeURIComponent(params[k]);\n    }\n    return url;\n}\n\nfunction onTokenLoginCompleted() {\n    // if we did a token login, we're now left with the token, hs and is\n    // url as query params in the url; a little nasty but let's redirect to\n    // clear them.\n    const url = new URL(window.location.href);\n\n    url.searchParams.delete(\"loginToken\");\n\n    logger.log(`Redirecting to ${url.href} to drop loginToken from queryparams`);\n    window.history.replaceState(null, \"\", url.href);\n}\n\nexport async function loadApp(fragParams: {}) {\n    initRouting();\n    const platform = PlatformPeg.get();\n\n    const params = parseQs(window.location);\n\n    const urlWithoutQuery = window.location.protocol + '//' + window.location.host + window.location.pathname;\n    logger.log(\"Vector starting at \" + urlWithoutQuery);\n\n    (platform as VectorBasePlatform).startUpdater();\n\n    // Don't bother loading the app until the config is verified\n    const config = await verifyServerConfig();\n    const snakedConfig = new SnakedObject<IConfigOptions>(config);\n\n    // Before we continue, let's see if we're supposed to do an SSO redirect\n    const [userId] = await Lifecycle.getStoredSessionOwner();\n    const hasPossibleToken = !!userId;\n    const isReturningFromSso = !!params.loginToken;\n    const ssoRedirects = parseSsoRedirectOptions(config);\n    let autoRedirect = ssoRedirects.immediate === true;\n    // XXX: This path matching is a bit brittle, but better to do it early instead of in the app code.\n    const isWelcomeOrLanding = window.location.hash === '#/welcome' || window.location.hash === '#';\n    if (!autoRedirect && ssoRedirects.on_welcome_page && isWelcomeOrLanding) {\n        autoRedirect = true;\n    }\n    if (!hasPossibleToken && !isReturningFromSso && autoRedirect) {\n        logger.log(\"Bypassing app load to redirect to SSO\");\n        const tempCli = createClient({\n            baseUrl: config.validated_server_config.hsUrl,\n            idBaseUrl: config.validated_server_config.isUrl,\n        });\n        PlatformPeg.get().startSingleSignOn(tempCli, \"sso\", `/${getScreenFromLocation(window.location).screen}`);\n\n        // We return here because startSingleSignOn() will asynchronously redirect us. We don't\n        // care to wait for it, and don't want to show any UI while we wait (not even half a welcome\n        // page). As such, just don't even bother loading the MatrixChat component.\n        return;\n    }\n\n    const defaultDeviceName = snakedConfig.get(\"default_device_display_name\")\n        ?? platform.getDefaultDeviceDisplayName();\n\n    const MatrixChat = sdk.getComponent('structures.MatrixChat');\n    return <MatrixChat\n        onNewScreen={onNewScreen}\n        makeRegistrationUrl={makeRegistrationUrl}\n        config={config}\n        realQueryParams={params}\n        startingFragmentQueryParams={fragParams}\n        enableGuest={!config.disable_guests}\n        onTokenLoginCompleted={onTokenLoginCompleted}\n        initialScreenAfterLogin={getScreenFromLocation(window.location)}\n        defaultDeviceDisplayName={defaultDeviceName}\n    />;\n}\n\nasync function verifyServerConfig() {\n    let validatedConfig;\n    try {\n        logger.log(\"Verifying homeserver configuration\");\n\n        // Note: the query string may include is_url and hs_url - we only respect these in the\n        // context of email validation. Because we don't respect them otherwise, we do not need\n        // to parse or consider them here.\n\n        // Note: Although we throw all 3 possible configuration options through a .well-known-style\n        // verification, we do not care if the servers are online at this point. We do moderately\n        // care if they are syntactically correct though, so we shove them through the .well-known\n        // validators for that purpose.\n\n        const config = SdkConfig.get();\n        let wkConfig = config['default_server_config']; // overwritten later under some conditions\n        const serverName = config['default_server_name'];\n        const hsUrl = config['default_hs_url'];\n        const isUrl = config['default_is_url'];\n\n        const incompatibleOptions = [wkConfig, serverName, hsUrl].filter(i => !!i);\n        if (incompatibleOptions.length > 1) {\n            // noinspection ExceptionCaughtLocallyJS\n            throw newTranslatableError(_td(\n                \"Invalid configuration: can only specify one of default_server_config, default_server_name, \" +\n                \"or default_hs_url.\",\n            ));\n        }\n        if (incompatibleOptions.length < 1) {\n            // noinspection ExceptionCaughtLocallyJS\n            throw newTranslatableError(_td(\"Invalid configuration: no default server specified.\"));\n        }\n\n        if (hsUrl) {\n            logger.log(\"Config uses a default_hs_url - constructing a default_server_config using this information\");\n            logger.warn(\n                \"DEPRECATED CONFIG OPTION: In the future, default_hs_url will not be accepted. Please use \" +\n                \"default_server_config instead.\",\n            );\n\n            wkConfig = {\n                \"m.homeserver\": {\n                    \"base_url\": hsUrl,\n                },\n            };\n            if (isUrl) {\n                wkConfig[\"m.identity_server\"] = {\n                    \"base_url\": isUrl,\n                };\n            }\n        }\n\n        let discoveryResult = null;\n        if (wkConfig) {\n            logger.log(\"Config uses a default_server_config - validating object\");\n            discoveryResult = await AutoDiscovery.fromDiscoveryConfig(wkConfig);\n        }\n\n        if (serverName) {\n            logger.log(\"Config uses a default_server_name - doing .well-known lookup\");\n            logger.warn(\n                \"DEPRECATED CONFIG OPTION: In the future, default_server_name will not be accepted. Please \" +\n                \"use default_server_config instead.\",\n            );\n            discoveryResult = await AutoDiscovery.findClientConfig(serverName);\n        }\n\n        validatedConfig = AutoDiscoveryUtils.buildValidatedConfigFromDiscovery(serverName, discoveryResult, true);\n    } catch (e) {\n        const { hsUrl, isUrl, userId } = await Lifecycle.getStoredSessionVars();\n        if (hsUrl && userId) {\n            logger.error(e);\n            logger.warn(\"A session was found - suppressing config error and using the session's homeserver\");\n\n            logger.log(\"Using pre-existing hsUrl and isUrl: \", { hsUrl, isUrl });\n            validatedConfig = await AutoDiscoveryUtils.validateServerConfigWithStaticUrls(hsUrl, isUrl, true);\n        } else {\n            // the user is not logged in, so scream\n            throw e;\n        }\n    }\n\n    validatedConfig.isDefault = true;\n\n    // Just in case we ever have to debug this\n    logger.log(\"Using homeserver config:\", validatedConfig);\n\n    // Add the newly built config to the actual config for use by the app\n    logger.log(\"Updating SdkConfig with validated discovery information\");\n    SdkConfig.add({ \"validated_server_config\": validatedConfig });\n\n    return SdkConfig.get();\n}\n"],"sourceRoot":""}